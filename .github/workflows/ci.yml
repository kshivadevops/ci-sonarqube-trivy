name: CI with SonarQube & Trivy (Code + Image Scan)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  code_quality_security_scan:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      # ---- Preflight: Check SONAR_TOKEN ----
      - name: Preflight – ensure SONAR_TOKEN present
        run: |
          if [ -z "${{ secrets.SONAR_TOKEN }}" ]; then
            echo "❌ SONAR_TOKEN is not set. Add it in: Settings > Secrets > Actions"
            exit 1
          fi
        shell: bash

      # ---- SonarQube Scan ----
      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@v2
        env:
          SONAR_HOST_URL: "http://host.docker.internal:9000"
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=ci-sonarqube-trivy
            -Dsonar.projectName=ci-sonarqube-trivy
            -Dsonar.sources=.

      # ---- Trivy Scan (Source Code & Dependencies) ----
      - name: Trivy File System Scan
        run: trivy fs --exit-code 1 --severity HIGH,CRITICAL .

      # ---- Docker Build ----
      - name: Build Docker image
        run: docker build -t myapp:latest .

      # ---- Trivy Scan Docker Image ----
      - name: Trivy Docker Image Scan
        run: trivy image --exit-code 1 --severity HIGH,CRITICAL myapp:latest
