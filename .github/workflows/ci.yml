name: DevSecOps CI (SonarQube • PyTest • Trivy • GitLeaks • SBOM • DockerHub)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  devsecops_ci:
    runs-on: self-hosted

    env:
      IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/ci-sonarqube-trivy

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install app + test deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install pytest pytest-cov

      # ---- Preflight: Check required secrets ----
      - name: Preflight – check required secrets
        run: |
          if [ -z "${SONAR_TOKEN}" ]; then echo "❌ Missing secret: SONAR_TOKEN"; exit 1; fi
          if [ -z "${DOCKERHUB_USERNAME}" ]; then echo "❌ Missing secret: DOCKERHUB_USERNAME"; exit 1; fi
          if [ -z "${DOCKERHUB_TOKEN}" ]; then echo "❌ Missing secret: DOCKERHUB_TOKEN"; exit 1; fi
          echo "✅ All required secrets are present"
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        shell: bash

      # ---- Unit tests + coverage.xml ----
      - name: Run tests with coverage
        run: |
          pytest -q --disable-warnings --maxfail=1 \
            --cov=. --cov-report=xml:coverage.xml || true

      # ---- SonarQube Scan (code quality + coverage) ----
      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@v2
        env:
          SONAR_HOST_URL: "http://host.docker.internal:9000"
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=ci-sonarqube-trivy
            -Dsonar.projectName=ci-sonarqube-trivy
            -Dsonar.sources=.
            -Dsonar.python.coverage.reportPaths=coverage.xml

      # ---- GitLeaks – secret scanning ----
      - name: GitLeaks scan
        run: |
          docker run --rm -v "$GITHUB_WORKSPACE:/repo" zricethezav/gitleaks:latest \
            detect -s /repo -v --exit-code 1 --redact

      # ---- Trivy – source (filesystem) scan ----
      - name: Trivy FS Scan (HIGH,CRITICAL fail)
        run: |
          trivy fs --scanners vuln,secret,config \
            --severity HIGH,CRITICAL \
            --exit-code 1 \
            --format table \
            . | tee trivy-fs.txt

      # ---- Build Docker image ----
      - name: Build Docker image
        run: |
          docker build -t $IMAGE_NAME:latest -t $IMAGE_NAME:${{ github.sha }} .

      # ---- Trivy – image scan ----
      - name: Trivy Image Scan (HIGH,CRITICAL fail)
        run: |
          trivy image --severity HIGH,CRITICAL \
            --exit-code 1 \
            --format table \
            $IMAGE_NAME:latest | tee trivy-image.txt

      # ---- Generate SBOM (CycloneDX) ----
      - name: SBOM (CycloneDX) via Trivy
        run: |
          trivy image --format cyclonedx \
            --output sbom.cdx.json \
            $IMAGE_NAME:latest
          echo "SBOM generated at sbom.cdx.json"

      # ---- Upload security artifacts ----
      - name: Upload security artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            trivy-fs.txt
            trivy-image.txt
            sbom.cdx.json

      # ---- Docker Hub login ----
      - name: Docker login
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      # ---- Push image (latest + sha) ----
      - name: Push image to Docker Hub
        run: |
          docker push $IMAGE_NAME:latest
          docker push $IMAGE_NAME:${{ github.sha }}
